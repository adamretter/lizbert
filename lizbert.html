<html>
<head>
     <script src='js/quintus-0.1.6/quintus-all.js'></script>
</head>
<body style="background-color: black;">
	<script>
        var soundEnabled = false; //TODO enable

        function stepCycleUpDown(cycleObj) {
            //make the lizbert player head 'bob' when walking
            if(cycleObj.frame.first < cycleObj.frame.current && cycleObj.frame.current < cycleObj.frame.last) {
                if(cycleObj.cycleForward) {
                    cycleObj.frame.current++;
                } else {
                    cycleObj.frame.current--;
                }
            } else if(cycleObj.frame.current == cycleObj.frame.last) {
                cycleObj.cycleForward = false;
                cycleObj.frame.current--;
            } else if(cycleObj.frame.current == cycleObj.frame.first) {
                cycleObj.cycleForward = true;
                cycleObj.frame.current++;
            }
        }

        function setupUpDownCycleFrames(first, last) {
            return {
                frame: {
                    first: first,
                    last: last,
                    current: first
                },
                cycleForward: true
            };
        }

        var Q = Quintus()
            .include("Sprites, Scenes, Input, 2D, Touch, UI, Audio")
            .setup({
                width: 960,
                height: 640,
                development: true,
                audioSupported: ['mp3', 'wav']
            }).enableSound().controls().touch();            
        
      
        //player
        Q.Sprite.extend("LizbertPlayer", {
            init: function(p) {
                this._super(p, {
                    sheet: "lizbert",
                    frame: 0,
                    jumpSpeed: -380,
                    jumping: false,                         //is lizbert jumping?
                    walking: setupUpDownCycleFrames(0, 3)  //frames for lizbert walking
                });
                this.add('2d, platformerControls');              
            },

            step: function(dt) {

                if(Q.inputs['left'] || Q.inputs['right']) {

                    //flip the sprite when walking left and then reset when walking right
                    if(Q.inputs['left'] && this.p.direction == 'right') {
                        this.p.flip = 'x';
                    } 
                    if(Q.inputs['right']  && this.p.direction == 'left') {
                        this.p.flip = false;                    
                    }

                    //make the lizbert player head 'bob' when walking
                    stepCycleUpDown(this.p.walking);

                    //set the frame to the walking frame
                    this.p.frame = this.p.walking.frame.current;

                } else if(Q.inputs['up']) {

                    //change the lizbert player sprite when jumping
                    this.p.jumping = true;
                    this.p.frame = 4;
                    
                    if(soundEnabled) {
                        Q.audio.play("wooh.mp3");
                    }

                    //restore jump sprite to walk sprite
                    this.on("bump.bottom", function(collision) {
                        if(this.p.jumping) {
                            this.p.jumping = false;
                            this.p.frame = this.p.walking.frame.current;
                        }
                    });
                }
            }                    
          });
                       
        
        Q.scene("level1",function(stage) {
          
            /* var background = new Q.TileLayer({ dataAsset: 'liz-level1.tmx', layerIndex: 0, sheet: 'tiles', tileW: 72, tileH: 72, type: Q.SPRITE_NONE });
            stage.insert(background);*/
            
            stage.collisionLayer(new Q.TileLayer({ dataAsset: 'level1.tmx', layerIndex: 0,  sheet: 'tiles', tileW: 35, tileH: 35 }));
          
            var player = stage.insert(new Q.LizbertPlayer());
            
            stage
                .add("viewport")
                .follow(player);
                //.follow(player, {x: true, y: true}, {minX: 0, maxX: background.p.w, minY: 0, maxY: background.p.h});
          
        });
        
        
        //load assets 
        Q.load("textures1.png, sprites.png, sprites.json, level1.tmx, wooh.mp3", function() {
          Q.compileSheets("sprites.png", "sprites.json");
          Q.sheet("tiles","textures1.png", { tileW: 72, tileH: 72});                
          Q.stageScene("level1");
        });
        
        
        </script>
   </body>
</html>